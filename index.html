<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>goki-chat</title>
    <style>
        /* Genel Stiller */
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: rgb(26 31 44);
            font-family: sans-serif;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 16px;
            background: transparent;
        }

        /* Tipografi */
        h1 {
            font-size: 24px;
            color: oklch(86.9% 0.022 252.894);
            padding: 0;
            margin: 0;
        }

        p {
            margin: 8px 0;
            color: #555;
            font-size: 14px;
        }

        /* Atomik CSS Sınıfları */
        .w-full { width: 100%; }
        .h-40 { height: 40px; }
        .min-h-40 { min-height: 40px; }
        .max-w-80 { max-width: 80%; }
        .max-w-300 { max-width: 300px; }

        .m-0 { margin: 0; }
        .m-auto { margin: auto; }
        .mb-8 { margin-bottom: 8px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-0 { margin-top: 0; }
        .mt-4 { margin-top: 4px; }
        .mt-n4 { margin-top: -4px; }
        .mr-6 { margin-right: 6px; }

        .p-0 { padding: 0; }
        .p-5 { padding: 5px; }
        .p-8 { padding: 8px; }
        .p-16 { padding: 16px; }
        .pb-5 { padding-bottom: 5px; }

        .flex { display: flex; }
        .inline-block { display: inline-block; }
        .block { display: block; }
        .hidden { display: none !important; }

        .flex-col { flex-direction: column; }
        .flex-row { flex-direction: row; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .self-start { align-self: flex-start; }
        .self-end { align-self: flex-end; }

        .gap-8 { gap: 8px; }

        .text-sm { font-size: 14px; }
        .text-xs { font-size: 10px; }
        .text-base { font-size: 16px; }
        .text-xl { font-size: 24px; }
        .text-right { text-align: right; }
        .text-light { color: oklch(86.9% 0.022 252.894); }
        .text-gray { color: rgb(156, 163, 175); }
        .text-error { color: #d00; }
        .text-blue { color: #007bff; }
        .text-blue-dark:hover { color: #0056b3; }

        .bg-transparent { background: transparent; }
        .bg-dark { background: rgb(26 31 44); }
        .bg-darker { background: rgba(42 47 63); }
        .bg-input { background: rgb(34 39 51); }
        .bg-primary { background: #603394; }
        .bg-primary-dark:hover { background: #491d7c; }

        .border-none { border: none; }
        .border-0 { border: 0; }
        .border-radius-4 { border-radius: 4px; }
        .border-radius-8 { border-radius: 8px; }
        .border-radius-12 { border-radius: 12px; }
        .border-radius-full { border-radius: 50%; }
        .border-top { border-top: 1px solid #ffffff1a; }
        .border-bottom { border-bottom: 1px solid #ffffff1a; }

        .outline-none { outline: none; }
        .cursor-pointer { cursor: pointer; }

        .relative { position: relative; }
        .absolute { position: absolute; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }

        .overflow-y-auto { overflow-y: auto; }
        .word-wrap { word-wrap: break-word; }
        .word-break-all { word-break: break-all; }
        .text-wrap-pretty { text-wrap: pretty; }
        .vertical-middle { vertical-align: middle; }

        /* Form Elemanları */
        input#name-input {
            font-size: 16px;
            background: rgb(26 31 44);
            color: oklch(86.9% 0.022 252.894);
            padding: 8px;
            width: inherit;
            border-radius: 4px;
            border: none;
            outline-color: rgb(84 105 212 / 0.5);
        }

        textarea {
            font-size: 16px;
            padding: 8px;
            border: 0;
            outline: none;
            width: inherit;
            background: transparent;
            min-height: 40px;
            color: oklch(86.9% 0.022 252.894);
        }

        button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        button.primary {
            width: 100%;
            background: #603394;
            color: #fff;
            height: 40px;
        }

        button.primary:hover {
            background: #491d7c;
        }

        /* Mesaj Bölümü */
        #messages {
            height: 80%;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 8px;
            background: transparent;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #ffffff1a;
            border-bottom: 1px solid #ffffff1a;
        }

        .bubble {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(42 47 63);
            color: oklch(86.9% 0.022 252.894);
            position: relative;
            word-break: break-all;
            text-wrap: pretty;
        }

        .username-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }

        .timestamp {
            display: block;
            font-size: 10px;
            color: rgb(156, 163, 175);
            margin-top: 4px;
            text-align: right;
        }

        /* Form ve Giriş Bölümleri */
        #message-form {
            display: flex;
            margin-bottom: 8px;
        }

        #message-form button {
            width: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #login-section {
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 8px;
            max-width: 300px;
            margin: auto;
            background: rgb(34 39 51);
            border-radius: 8px;
        }

        #logout-btn {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }

        #logout-btn:hover {
            color: #0056b3;
        }

        /* Özel Bileşenler */
        .send-message {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            border-radius: 4px;
            padding: 8px;
            background: rgb(34 39 51);
        }
    </style>
</head>
<body>
<div class="container">
    <section id="login-section" class="flex flex-col p-16 gap-8 max-w-300 m-auto bg-input border-radius-8">
        <h1 class="text-xl text-light m-0 p-0">Sohbete Katıl</h1>
        <p class="text-sm">Sohbet odasına katılmak için lütfen adınızı girin.</p>
        <form id="login-form">
            <div class="flex flex-col gap-8">
                <input id="name-input" type="text" required placeholder="İsminiz">
                <button type="submit" class="primary">Giriş Yap</button>
                <p id="login-error" class="text-error text-sm mt-n4"></p>
            </div>
        </form>
        <strong class="text-light">Not:</strong>
        <p class="text-sm">Düsuk internet bağlantısı nedeniyle mesajlarınız geç görünebilir.Sadece belirli insanlarin iletiimi icin kullnima aciktir.</p>
    </section>
    <section id="chat-section" class="hidden">
        <div class="flex flex-row justify-between items-center pb-5">
            <h1 class="text-xl text-light m-0 p-0">Sohbet Odası</h1>
            <div class="flex flex-row items-center gap-8">
                <p class="text-sm">Hoş geldin <strong id="current-user"></strong></p>
                <button id="logout-btn" class="border-none bg-transparent text-blue cursor-pointer p-0 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" x2="9" y1="12" y2="12"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="messages" class="border-top border-bottom mb-20 overflow-y-auto"></div>
        <form id="message-form" class="flex mb-8">
            <div class="relative w-full flex p-5 send-message">
                <textarea id="message-input" placeholder="Mesajınız…" required rows="1" class="text-base p-8 border-0 outline-none w-full bg-transparent min-h-40 text-light"></textarea>
                <button type="submit" class="absolute top-0 right-0 bg-transparent" aria-label="Gönder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lov-name="Send">
                        <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
                        <path d="m21.854 2.147-10.94 10.939"></path>
                    </svg>
                </button>
            </div>
        </form>
    </section>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const LOGIN_KEY = 'chat_username';
    const SUPABASE_URL = 'SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'SUPABASE_ANON_KEY';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    const loginSection = document.getElementById('login-section');
    const chatSection = document.getElementById('chat-section');
    const loginForm = document.getElementById('login-form');
    const nameInput = document.getElementById('name-input');
    const loginError = document.getElementById('login-error');
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const logoutBtn = document.getElementById('logout-btn');
    const currentUserDisplay = document.getElementById('current-user');

    const userColors = {};
    function getUserColor(name) {
        const key = name.toLowerCase();
        if (!userColors[key]) {
            userColors[key] = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        }
        return userColors[key];
    }

    // Kayıtlı kullanıcıyı kontrol et
    (async () => {
        const stored = localStorage.getItem(LOGIN_KEY);
        if (stored) {
            console.log('Checking stored user:', stored);
            const { data, error } = await supabase
                .from('allowed_users')
                .select('name')
                .eq('name', stored.toLowerCase())
                .single();
            console.log('Stored user check result:', { data, error });
            if (data && !error) {
                currentUser = stored;
                showChat();
            } else {
                localStorage.removeItem(LOGIN_KEY);
                console.error('Stored user invalid:', error?.message || 'No data');
            }
        }
    })();

    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = nameInput.value.trim();
        console.log('Attempting login with name:', name);
        const { data, error } = await supabase
            .from('allowed_users')
            .select('name')
            .eq('name', name.toLowerCase())
            .single();
        console.log('Login check result:', { data, error });

        if (error || !data) {
            loginError.textContent = 'Erişim reddedildi: İsim listede yok.';
            console.error('Login failed:', error?.message || 'No data');
            return;
        }

        currentUser = name;
        localStorage.setItem(LOGIN_KEY, name);
        loginError.textContent = '';
        showChat();
    });

    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem(LOGIN_KEY);
        location.reload();
    });

    function showChat() {
        loginSection.classList.add('hidden');
        chatSection.classList.remove('hidden');
        currentUserDisplay.textContent = currentUser;
        startListening();
    }

    async function startListening() {
        console.log('Starting to listen for messages');
        const { data: messages, error } = await supabase
            .from('messages')
            .select('*')
            .order('inserted_at', { ascending: true });
        console.log('Fetched messages:', { messages, error });
        messages?.forEach(renderMessage);
        await supabase
            .channel('public:messages')
            .on('postgres_changes', {event: 'INSERT', schema: 'public', table: 'messages'}, payload => {
                console.log('New message received:', payload.new);
                renderMessage(payload.new);
            })
            .subscribe();
    }

    function renderMessage({ sender, content, inserted_at }) {
        const div = document.createElement('div');
        const isCurrentUser = sender === currentUser;
        div.className = `message mb-8 max-w-80 word-wrap flex ${isCurrentUser ? 'self-end' : 'self-start'}`;

        const color = getUserColor(sender);
        const bubble = document.createElement('span');
        bubble.className = 'bubble inline-block border-radius-12 bg-darker text-light relative word-break-all text-wrap-pretty';

        const dot = document.createElement('span');
        dot.className = 'username-dot inline-block border-radius-full mr-6 vertical-middle';
        dot.style.backgroundColor = color;

        bubble.appendChild(dot);

        const nameText = document.createElement('strong');
        nameText.textContent = sender;
        bubble.appendChild(nameText);
        bubble.appendChild(document.createElement('br'));

        const contentText = document.createTextNode(content);
        bubble.appendChild(contentText);

        const time = document.createElement('span');
        time.className = 'timestamp block text-xs text-gray mt-4 text-right';
        time.textContent = new Date(inserted_at).toLocaleTimeString();
        bubble.appendChild(time);

        div.appendChild(bubble);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    messageForm.addEventListener('submit', async e => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        console.log('Sending message:', { sender: currentUser, content });
        const { data, error } = await supabase
            .from('messages')
            .insert({ sender: currentUser, content })
            .select()
            .single();
        console.log('Message send result:', { data, error });

        if (error) {
            loginError.textContent = 'Hata: Mesaj gönderilemedi. Geçerli bir kullanıcı adı kullanın.';
            console.error('Message send failed:', error.message);
            return;
        }

        if (data) {
            renderMessage(data);
        }
        messageInput.value = '';
    });
</script>
</body>
</html>


